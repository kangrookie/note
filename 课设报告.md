# <center>面向对象课程设计(荣誉课)实验报告·终
## 一、项目的需求

1. 项目的背景
本项目目标是实现简易微商平台，满足网购的基本功能
2. 功能需求
   1. 客户端
      1. 登录：
   在此时创建异步socket套接字建立于服务端的连接，用于后续服务端通信。
    填写账号和密码，通过网络协议传送至服务端，服务端调用数据库检测账号是否存在以及密码是否正确，如果没通过则返回客户端，通过后，调取该用户的信息，传送至客户端
       2. 注册账号：
    填写填写账号，名称，密码，通过网络协议传送至服务端，服务端会调用数据库内信息对账号进行查重，保证账号的唯一性，如果没通过查重则返回客户端，通过后将账号密码名称等信息储存
       3. 与客服通信：
    通过异步网络通信，客户端与服务端能够建立持久的实时通信连接。用户发送的消息会迅速传递至服务端，并由服务端即时转发给客服人员。客服的回复同样通过此连接即时传送至客户端，并动态显示在UI界面的聊天窗口中，确保双方沟通顺畅无阻。且在界面上进行了对话框气泡界面美化。使得界面显得更加美观，且聊天的过程中还会有隔断的时间提醒。
       4. 商品选购界面：
          1. 模糊搜索功能：
        该功能允许用户对商品进行实时的模糊搜索。用户只需在搜索框内输入关键词，系统便会立即向服务端发送搜索请求。服务端接收到请求后，会迅速在商品数据库中进行模糊匹配，查找与关键词相关的商品信息。搜索过程中，系统会实时返回查询结果，并通过客户端的界面展示给用户。这些结果以列表形式呈现，每一项都包含了商品的名称、图片、价格等关键信息。这样的设计不仅提高了搜索效率，还为用户提供了更加便捷、流畅的购物体验。
          2. 选购：
        用户浏览商品页面时，可以自由选择对心仪的商品进行直接购买或加入购物车以备后续挑选。若选择直接购买，客户端自动向服务端发送购买请求。服务端在接收到请求后，会迅速启动一系列验证流程，以确保此次购买操作的合法性。一旦验证通过，服务端将即刻生成订单，并根据订单详情对数据库中的商品库存、销售量等相关信息进行实时更新。
       5. 购物车:
    实现对商品的选择的增加，删除，结算服务，采用了多选化管理设计，允许用户同时选中多项商品进行统一操作。无论是结算还是删除，用户都只需简单勾选所需商品,操作便捷高效。
       6. 秒杀服务：
    接收到商家设置的秒杀活动，秒杀活动在特定时间开始，限制购买数量，同时有更大的优惠力度。且购买秒杀商品生成的订单具有短时性，以便防止用户拖延不支付，影响其他用户购买体验。
       7. 订单查询：
    当用户发起购买请求时，会生成订单，用户可以对所有订单进行查看，订单分为未支付订单，已支付订单和过期订单，（每个订单都有有效期，当超过有效期后，未支付订单变为过期订单，服务端返回库存）
       8. 用户信息：
    支持用户对自己信息的修改，包括修改昵称，修改密码，修改联系电话，向服务端发送更改请求，由服务端实现用户信息的更改
    2. 服务端
        1. 用户信息综合处理
        用户信息综合处理完全由服务器端后台自动执行，无需管理者人工操作。其主旨在于即时响应客户端提出的数据传输、数据修改及操作请求，以及处理支付功能等相关事务。涵盖的功能有客户端页面的初始化数据提供，处理来自客户端的购买、搜索及退货等请求。服务端在成功响应这些请求后，会自动给出提示，比如购买成功的反馈，登录成功的反馈。
        2. 与用户通信：
        客服可以与所有的用户进行聊天通信，无论对方是否在线。其他功能与客户端类似
        3. 商品的上架与下架：
        商品的上架与下架功能由服务端全权处理。管理员负责将商品的图片、详细信息、价格以及存货数量等关键信息上传并存储至数据库中，以此实现商品的上架操作，从而扩充商品库。相应地，服务端也能够执行下架操作，即从数据库中移除对应商品的信息，使其不再对外展示。
        5. 发布与删除秒杀活动:
        秒杀活动的发布与删除功能由服务端全权处理。管理员负责将商品的图片、开始时间、价格以及出售数量关键信息上传并存储至数据库中，以此实现秒杀活动的发布操作。相应地，管理员也能够执行删除操作，即从数据库中移除对应活动的信息，使其不再对外展示。
        6. 对于未支付订单
        服务端后台自动发每隔一段时间，自动检查数据库中未支付的过期订单，对过期订单标记已过期并归还商品库存。
        7. 数据分析
        允许管理员进行数据统计和分析，这一功能可以全面覆盖所有人的购买情况以及全部货物的销售情况。管理员可以通过系统轻松地获取到详细的购买记录和销售数据，进而利用这些数据生成直观、易于理解的图表信息。无论是单个顾客的购买历史，还是特定商品的销售趋势，都能通过图表的形式清晰展现，从而实现数据的可视化，为管理员提供有力的决策支持。
3. 性能需求
   -  客户端执行操作时，采取的是尽量少申请数据库操作指令，在迫不得已时才与数据库进行间接交换，保证了在高并发模式下，客户端一定的高性能。  
   - 在服务端要面对多客户端所产生的高并发问题，对服务器的频繁访问会导致性能问题，主要体现在秒杀活动。
   在秒杀活动中，可能会遇到多个用户同时申请的情况。若使用单线程处理，会因速度过慢而导致服务器卡死问题。因此，在高并发模式下，我们需要借助多线程来提高信息接收的速率。本程序在异步socket连接上采用了多线程的处理方式，并充分考虑到了高性能的问题。具体做法是，每一个socket分配一个线程，但在这种情况下，多个socket会产生多个线程，且线程内部在大部分时刻都处于空闲状态。因此，过多的线程运行会导致主机内存占用比升高，影响服务器的承载能力。为此，本程序采用了线程管理的方式，将线程集中起来管理，形成线程池，负责控制线程的产生和释放。这样，一个线程可以负责控制多个socket的运行，既防止了多线程带来的高性能问题，也进一步实现了高并发。
## 系统设计
### 数据库设计
1. 数据库表单设计
   包含用户信息、商品信息、秒杀活动、购物车记录、聊天记录、订单记录表单
   #### 用户信息

   | 名称     | 类型    | 是否为key |
   | ------- | ------- | --------- |
   | id       | int     | yes       |
   | name     | varchar | no        |
   | password | varchar | no        |
   | tel      | varchar | no        |

    #### 商品信息
   | 名称   | 类型    | 是否为key |
   | ------ | ------- | --------- |
   | id     | int     | yes       |
   |price   | int     | no        |
   | name   | varchar | no        |
   | image  | varchar | no        |
   | sales  | int     | no        |
   | stocks | int     | no        |
   |description| varchar| no|
    #### 购物车记录

   | 名称      | 类型 | 是否为key |
   | --------- | ---- | --------- |
   | id        | int  | yes       |
   | client_id | int  | no        |
   | goods_id  | int  | no        |
   |price |int|no|
   |name|varchar|no|
   |image|varchar|no|
    #### 聊天消息

   | 名称    | 类型     | 是否为key |
   | ------- | -------- | --------- |
   | id      | int      | yes       |
   | send_id | int      | no        |
   | who     | bool     | no        |
   | content | varchar  | no        |
   | time    | datetime | no        |

    #### 秒杀活动

   | 名称       | 类型     | 是否为key |
   | ---------- | -------- | --------- |
   | id        | varchar  | yes       |
   | goods_id    | int | no        |
   |price   | int     | no        |
   | time       | datetime | no        |
   |num|int|no|
   |description|varchar|no|
   |image|varchar|no|

    #### 订单

   | 名称      | 类型     | 是否为key |
   | --------- | -------- | --------- |
   | id        | varchar  | yes       |
   | goods_id  | int      | no        |
   | time      | datetime | no        |
   | client_id | int      | no        |
   | state     | bool     | no        |
   | valid     | datetime | no        |
   | value     | int      | no        |
   | num       | int      | no        |
   | back      | bool     | no        |
2. SQL触发器设计
   触发器是一种特殊的存储过程，与表事件相关，其执行不是由程序调用或手工启动，而是由事件触发。当对表中的数据进行插入（INSERT）、更新（UPDATE）或删除（DELETE）操作时，触发器会自动被激活。利用触发器可以设置操作判断来保证操作合法，防止非法操作的执行
   - 商品存货不足：在商品购买减库存时，改变商品表单信息时会检查商品数量是否足够
   - 订单支付：在订单支付时，检查该订单是否过期，如果过期则返回订单已过期
   - 购物车添加：在将一个商品添加至购物车时不允许同一个商品多次添加

   将操作合法性检验由SQL触发器实现而非交给服务端实现，一定程度上简化了代码，优化了项目结构。
### UI设计
采用QT框架实现简单的UI界面，并做了一定的美化处理，能够美观，高效，方便的实现操作
1. 客户端
   1. 登录页面
   ![](.\image\登录.png)
   2. 注册页面
   ![](.\image\注册.png)
   3. 商城页面
   ![](.\image\商城.png)
   4. 直接购买
   ![](.\image\购买1.png)
   ![](.\image\购买2.png)
   5. 商品搜索
   ![](.\image\搜索.png)
   6. 个人信息更改
   ![](.\image\个人信息.png)
   7. 秒杀活动页面
   ![](.\image\秒杀活动.png)
   8. 订单页面
   ![](.\image\订单页面.png)
   9.  订单展示
   ![](.\image\订单展示.png)
   10. 与客服聊天
   ![](.\image\聊天.png)
2. 服务端
   1. 数据分析
   ![alt text](.\image\饼状图.png) 
   ![alt text](.\image\柱状图.png)
   2. 聊天页面 
   ![alt text](.\image\客服聊天.png)
   3. 配置秒杀活动 
   ![alt text](.\image\活动商品配置.png)
   4. 配置商品页面 
   ![alt text](.\image\配置商品.png)
   5. 添加商品
   ![alt text](.\image\添加商品.png)
### 类设计
1. 客户端
   1. UI界面类
   - CarouselImageWindow
   用于商城图片滚动展示
   - Activityscrollarea
   存放秒杀活动的窗口
   - Billdialog
   显示订单信息的窗口
   - Billlistwidget
  展示所有订单的窗口
   - ChatWindow
  展示聊天信息的窗口
   - Shoplistwidget
  展示所有购物车商品的窗口
   - ShoppingCart
  存放购物车商品的窗口
   - Mydialog
  填写购买数量和地址的窗口
   - Myscrollarea
   存放商品的窗口
   1. 信息类
   - Account
  存放用户账号的密码，用于登录核验
   - Activity
  存放秒杀活动的信息
   - Administrator
  存放用户信息
   - Bill
  存放单个订单的信息
   - Chat
  存放单条聊天信息
   - Cart
  存放购物车商品信息
   - Goods
  存放商品信息
1. 服务端
   1. UI界面类
   - Chart
  用于数据分析可视化生成图表
   - Scrollarea
  存放用户，用于聊天时选择用户
   1. 信息类（同客户端）
   2. 功能类
   - TcpServer
  用于监听socket请求，并申请线程用于后续通信
   - TcpSocket
  负责接收客户端信息，并译码响应客户端操作
   - Dao
  存放所有数据库操作
   - TreadPool
  用于线程管理
## 相关技术
1. 基于Qt框架的C++可视化编程
   本程序的所有可视化窗口均基于Qt框架进行编程，涉及了Qt中QWidget的各种变换、数据传递、界面设计、控件设计，并涵盖了界面美观技术。
   - QCharts的使用操作,常见的柱状图，饼图的绘制 
   - 信号与槽机制的使用 
   - QT设计师页面的使用
   - QString的常用功能 
   - Qt容器的使用，和Qt小控件的使用 ，例如QStackedWidget，QListWidget等
2. 多线程socket通信与线程管理
   对于线程管理通过TreadPool类进行对线程的管理，避免线程内部在大部分时刻都处于空闲状态，将线程集中起来管理，形成线程池，负责控制线程的产生和释放
   服务端利用TcpServer类接收客户端发送的socket申请，TcpServer继承自QT的QTcpServer类，对incomingconnection函数进行重写，当接收到申请时向TreadPool申请一个空闲线程，并将TcpServer生成的socket传递给这个线程，保证一个线程一个socket。防止了多线程带来的高性能问题，也进一步实现了高并发。
3. 持久层的实现
   在本项目中，我们采用了Qt框架中的QSqlDatabase类来实现服务端与数据库之间的连接。QSqlDatabase类提供了与各种数据库进行交互的接口，通过配置相应的连接参数，如数据库类型、主机名、端口号、数据库名、用户名和密码等，实现服务端与MySQL数据库的连接。
   进一步，利用Qt框架中的QSqlQuery类来向数据库发送MySQL语句。QSqlQuery类允许执行SQL查询并获取结果，同时支持各种数据库操作，如插入、更新、删除和查询等。通过构建适当的SQL语句，并利用QSqlQuery类执行这些语句，实现了对数据库的高效操作，包括数据的增删改查等。
4. 数据库的并发和互斥
   并发允许多个任务同时执行，而互斥则确保同一时间只有一个任务可以访问共享资源。在数据库操作时，允许多个进程同时对数据进行读取，一旦有一个进程发生写操作，此时只允许该线程访问数据路，使用适当的同步机制（如读写锁等）来避免数据竞争和死锁等问题。保证数据的可靠性和有效性。
5. C/S结构
   本项目全面分为三个核心组成部分：数据库、服务端以及客户端。其中，数据库与服务端之间通过持久层技术实现连接，确保数据的稳定性和一致性。客户端与服务端则采用TCP协议进行通信。整体系统架构严格遵循C/S结构，即客户端与服务器直接进行通信，这种设计模式特别适用于对性能和交互复杂度有较高要求的场景，确保了系统的高性能和稳定性。
## 反思与总结
1. UI界面的流畅与美观方面
   整体来说页面基本完成美化，但是效果还是不够好，缺少更流畅的页面切换和动画设计。
2. 结构设计上和设计模式应用方面
   虽在项目开始前有大致框架，但是没有细节去想需要那些类和类之间的关系，导致后期项目结构有点混乱，且没有充分体现面向对象复用的思想，需要进一步的调整，接下来将从这一方面对相关知识进行系统学习，并对项目进行进一步优化设计。
3. 持久层实现方面
   持久层的实现虽然由读写锁等一系列实现并发的机制，但是没有利用Java框架实现持久层，所以可扩展性的安全性还是有一定缺陷，但是好在已经将持久层充分包装完整，可以较为方便的实现后续持久层的更改